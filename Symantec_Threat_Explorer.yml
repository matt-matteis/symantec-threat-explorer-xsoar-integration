commonfields:
  id: Symantec Threat Explorer
  version: -1
vcShouldKeepItemLegacyProdMachine: false
name: Symantec Threat Explorer
display: Symantec Threat Explorer
category: Utilities
image: data:image/png;base64,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
description: Integration to interact with the Symantec Threat Explorer REST API
detaileddescription: |-
  ### Community Contributed Integration
   #### Integration Author: Matt Matteis
   No support or maintenance is provided by the author. Customers are encouraged to engage with the user community for questions and guidance at the [Cortex XSOAR Live Discussions](https://live.paloaltonetworks.com/t5/cortex-xsoar-discussions/bd-p/Cortex_XSOAR_Discussions).
  ***
  ## Symantec Threat Explorer
  - Configure your URL for Threat Explorer (Defaults: https://threatexplorer.symantec.com)
  - Generate and configure your Threat Explorer API key  (https://techdocs.broadcom.com/us/en/symantec-security-software/web-and-network-security/threat-explorer/all/api-home/api-generate.html)


  ---
  [View Integration Documentation](https://threatexplorer.symantec.com/)
configuration:
- section: Connect
  display: Server URL (e.g., https://threatexplorer.symantec.com)
  name: url
  defaultvalue: https://threatexplorer.symantec.com
  type: 0
  required: true
- section: Connect
  advanced: true
  display: Trust any certificate (not secure)
  name: insecure
  type: 8
  required: false
- display: ""
  name: api_key
  type: 4
  required: true
script:
  script: |-
    import traceback
    from typing import Any, Dict

    CMD_PREFIX = "Symantec.ThreatExplorer"

    class Client(BaseClient):
        def get_url_whois(self, url: str) -> Dict[str, str]:
            params = {"url": url}
            return self._http_request(method="GET", url_suffix="/whois", params=params)

        def get_url_history(self, url: str) -> Dict[str, Any]:
            params = {"url": url}
            return self._http_request(method="GET", url_suffix="/history", params=params)

        def get_url_info(self, url: str) -> Dict[str, Any]:
            params = {"url": url}
            return self._http_request(method="GET", params=params)


    def get_url_info_command(client: Client, args: Dict) -> CommandResults:
        """
        This function calls the Symantec Threat Explorer information endpoint
        to get threat level and categorization for a URL.

        Args:
            client (Client): a client object.
            args (Dict): a dictionary of arguments passed to the command.

        Returns:
            CommandResults: a CommandResults object to return results to the context
                            and a table representation to the war room.
        """
        if not "url" in args:
            raise DemistoException("url cannot be empty")

        url = args["url"]
        response = client.get_url_info(url=url)

        readable_output = tableToMarkdown("Symantec Threat Explorer URL Info", response)

        return CommandResults(
            readable_output=readable_output,
            outputs_prefix=f"{CMD_PREFIX}.ThreatInfo",
            outputs=response
        )


    def get_url_history_command(client: Client, args: Dict) -> CommandResults:
        """
        This function calls the Symantec Threat Explorer /history endpoint
        to get historic threat level info about the domain in the url.

        Args:
            client (Client): a client object.
            args (Dict): a dictionary of arguments passed to the command.

        Returns:
            CommandResults: a CommandResults object to return results to the context
                            and a table representation to the war room.
        """
        if not "url" in args:
            raise DemistoException("url cannot be empty")

        url = args["url"]
        response = client.get_url_history(url=url)

        readable_output = tableToMarkdown("Symantec Threat Explorer History", response)

        return CommandResults(
            readable_output=readable_output,
            outputs_prefix=f"{CMD_PREFIX}.ThreatHistory",
            outputs=response
        )


    def get_whois_command(client: Client, args: Dict) -> CommandResults:
        """
        This function calls the Symantec Threat Explorer /whois endpoint
        to get basic info about the domain in the url.

        Args:
            client (Client): a client object.
            args (Dict): a dictionary of arguments passed to the command.

        Returns:
            CommandResults: a CommandResults object to return results to the context
                            and a table representation to the war room.
        """

        if not "url" in args:
            raise DemistoException("url cannot be empty")

        url = args["url"]
        response = client.get_url_whois(url=url)

        readable_output = tableToMarkdown("Symantec Threat Explorer WHOIS", response)

        return CommandResults(
            readable_output=readable_output,
            outputs_prefix=f"{CMD_PREFIX}.WHOIS",
            outputs=response
        )


    def test_module(client: Client):
        """
        This function makes a call to the /whois endpoint with a static URL
        of 'www.symantec.com' to test authentication.

        Returning 'ok' indicates that an expected response was returned and the integration
        configuration is valid.

        Args:
            client (Client): a client object

        Returns:
            'ok' if test passed, raw HTTP response if not
        """
        response = client.get_url_whois("www.symantec.com")
        if "registrantOrganization" in response:
            return "ok"
        else:
            return response


    def main() -> None:

        base_url = demisto.params().get("url")
        verify_certificate = not demisto.params().get("insecure", False)
        api_key = demisto.params().get("api_key")

        try:
            headers = {
                "Content-Type": "application/json",
                "Authorization": api_key
            }

            client = Client(
                base_url=f"{base_url}/api/v1/url",
                verify=verify_certificate,
                headers=headers
            )

            if demisto.command() == "threat-explorer-get-url-info":
                return_results(get_url_info_command(client, demisto.args()))
            elif demisto.command() == "threat-explorer-get-url-history":
                return_results(get_url_history_command(client, demisto.args()))
            elif demisto.command() == "threat-explorer-whois":
                return_results(get_whois_command(client, demisto.args()))
            elif demisto.command() == "test-module":
                return_results(test_module(client))

        except Exception as e:
            demisto.error(traceback.format_exc())  # print the traceback
            return_error(f"Failed to execute {demisto.command()} command.\nError:\n{str(e)}")


    """ ENTRY POINT """
    if __name__ in ("__main__", "__builtin__", "builtins"):
        main()
  type: python
  commands:
  - name: threat-explorer-get-url-info
    arguments:
    - name: url
      required: true
      description: URL for which to retrieve Threat Explorer info
    outputs:
    - contextPath: Symantec.ThreatExplorer.ThreatInfo.threatRiskLevel.level
      description: URL threat level
      type: number
    - contextPath: Symantec.ThreatExplorer.ThreatInfo.threatRiskLevel.lastUpdated
      description: Threat level last update date
      type: date
    - contextPath: Symantec.ThreatExplorer.ThreatInfo.categorization.categories
      description: URL threat categories
      type: unknown
    - contextPath: Symantec.ThreatExplorer.ThreatInfo.categorization.categories.name
      description: Threat cateogy name
  - name: threat-explorer-get-url-history
    arguments:
    - name: url
      required: true
      description: URL for which to retrieve Threat Explorer history
    outputs:
    - contextPath: Symantec.ThreatExplorer.ThreatHistory.threatRiskLevelHistory
      description: Threat history summary
      type: unknown
    - contextPath: Symantec.ThreatExplorer.ThreatHistory.threatRiskLevelHistory.level
      description: Threat level
      type: number
    - contextPath: Symantec.ThreatExplorer.ThreatHistory.threatRiskLevelHistory.updated
      description: Last update to threat level
      type: date
  - name: threat-explorer-whois
    arguments:
    - name: url
      required: true
      description: URL for the WHOIS lookup
    outputs:
    - contextPath: Symantec.ThreatExplorer.WHOIS.created
      description: Domain creation date
      type: date
    - contextPath: Symantec.ThreatExplorer.WHOIS.expires
      description: Domain expiration date
      type: date
    - contextPath: Symantec.ThreatExplorer.WHOIS.updated
      description: Domain last updated date
      type: date
    - contextPath: Symantec.ThreatExplorer.WHOIS.registrar
      description: Domain registrar
      type: string
    - contextPath: Symantec.ThreatExplorer.WHOIS.registrantOrganization
      description: Organization
      type: string
  dockerimage: demisto/python3:3.10.13.89009
  runonce: false
  subtype: python3
